# Intel oneAPI MKL FFI bindings

This crate contains Intel oneAPI MKL (Math Kernel Library) FFI bindings.

Current FFI version is oneAPI MKL 2025.2 [(link to download page)](https://www.intel.com/content/www/us/en/developer/tools/oneapi/toolkits.html). If you are using an older version of oneAPI MKL, this crate should still work if you do not explicitly call the function that only occurs in higher version of oneAPI MKL.

> **Feature Not Complete**: oneAPI MKL is a large collection of math functions. This crate currently only have following bindgens:
> - service (`mkl_service.h`)
> - blas, cblas
> - lapack, lapacke
>
> We surely want to perform more bindgens (such as paradiso, trans, poisson, fft, dft, etc.) in future; but these are not of priority for project REST and RSTSR. If you wish to put these bindgens in this crate, currently you can file an issue, and we will quickly realize the bindgen of other features in oneAPI MKL.

Intel oneAPI MKL is freely distributed in binary (along with header), not source code. Please note the license of oneAPI (Intel Simplified Software License) is not fully free software.

This crate is not official bindgen project. It is originally intended to serve rust tensor toolkit [RSTSR](https://github.com/RESTGroup/rstsr) and rust electronic structure toolkit [REST](https://gitee.com/RESTGroup/rest).

- **Audience**: Anyone uses MKL function may also find it useful, not only RSTSR or REST program developers.
- **Pure Extern or Dynamic Loading**: This crate supports either pure extern (usual FFI, requires dynamic or static linking) and dynamic-loading, by cargo feature `dynamic_loading`.

## Dynamic loading

This crate supports dynamic loading by default.

If you do not want to use dynamic loading, please disable default cargo features (`--no-default-features` when cargo build).

The dynamic loading will try to find proper library when your program initializes. If you want to override the library to be loaded, please set these shell environmental variable `RSTSR_DYLOAD_MKL` to the dynamic library path.

**NOTE**: When you call BLAS and LAPACK functions with dynamic loading, please **DO NOT USE** other crates (such as `rstsr_lapack_ffi`). Please make sure you are only using `rstsr_mkl_ffi::blas`, `rstsr_mkl_ffi::cblas` and `rstsr_mkl_ffi::lapack`. Sticking to using `rstsr_mkl_ffi` will make sure you are calling BLAS and LAPACK functions from oneAPI MKL, instead of other BLAS vendors.

If you encountered large compile time or disk consumption, you may consider add these lines in your Cargo.toml:

```toml
[profile.dev.package.rstsr-mkl-ffi]
opt-level = 0
debug = false
```

## Cargo features

Default features:

- `dynamic_loading`: Supports dynamic loading.
- `blas`: Inclulde BLAS bindgens.
- `cblas`: Include CBLAS bindgens.
- `lapack`: Include LAPACK bindgens.

Optional features:

- `ilp64`: Use `int64_t` for dimension specification, or lapack error code types if this feature specified. Otherwise, use `int32_t`.
    - Please note that in module `blas`, error code is returned by `c_int`; in module `cblas`, oneAPI MKL utility functions use `c_int` for input or output.
- `lapacke`: Include LAPACKE bindgens.

## Crate structure

- `header`: Header files copied (or renamed) from original source.
- `scripts`: Script to generate FFI bindgens.
- `src`: FFI bindings:
    - `blas`: Corresponds to `f77blas.h` header in compiled library include (or `common_interface.h` in oneAPI MKL original source code). BLAS and some LAPACK functions that implemented by oneAPI MKL, no post-suffix underscore.
    - `cblas`: Corresponds to `cblas.h` header. Original CBLAS included, along with oneAPI MKL utility functions (e.g. `oneAPI MKL_get_num_threads`) and some BLAS extensions (e.g. `cblas_zgemm_batch`).
- In each bindgens, the following files are usually automatically generated by scripts:
    - `ffi_base.rs`: Basic type, enum, struct definitions.
    - `ffi_extern.rs`: Unsafe extern "C" bindgen functions. Only activated when not dynamic loading.
    - `dyload_struct.rs`: Struct `Lib` for dynamic loading.
    - `dyload_initializer.rs`: The initialization function of `Lib` for dynamic loading.
    - `dyload_compatible.rs`: Unsafe bindgen function that is compatible to that of `ffi_extern.rs`. Only activated when dynamic loading.
    - special case of `cblas::ffi_base`: the enums `CBLAS_TRANSPOSE`, `CBLAS_UPLO`, etc comes from crate `rstsr_lapack_ffi` for convenience. This crate depends on `rstsr_lapack_ffi` for those definitions of enums.

## Changelog

- v0.1.1

    - **Fix**: Add compatibility of definition of `blas_int` and `lapack_int`.

- v0.1.0

    - **Initialize**: Added blas, cblas, lapack, lapacke bindgens.
